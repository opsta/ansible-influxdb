---
- include_tasks: influxdb_auth_remove.yml

- name: Add influxdb users with all privileges
  command: >
    influx -execute
    "CREATE USER {{ item.username }} WITH PASSWORD '{{ item.password }}'"
  with_items: "{{ influxdb_credentials_admin }}"
  no_log: true
  register: influxdb_command_result
  failed_when: "'user already exists' not in influxdb_command_result.stderr and influxdb_command_result.rc != 0"

- name: Grant all priviledges to admin users
  command: >
    influx -execute
    "GRANT ALL PRIVILEGES TO {{ item.username }}"
  with_items: "{{ influxdb_credentials_admin }}"
  no_log: true

- name: Add influxdb normal users
  command: >
    influx -execute
    "CREATE USER {{ item.username }} WITH PASSWORD '{{ item.password }}'"
  with_items: "{{ influxdb_credentials_user }}"
  no_log: true
  register: influxdb_command_result
  failed_when: "'user already exists' not in influxdb_command_result.stderr and influxdb_command_result.rc != 0"

- name: Grant privileges to existing user
  command: >
    influx -execute
    "GRANT {{ item.1.split('.')[0] }} ON {{ item.1.split('.')[1] }} TO {{ item.0.username }}"
  with_subelements:
    - "{{ influxdb_credentials_user }}"
    - databases
  no_log: true
  
- include_tasks: influxdb_auth_revert.yml